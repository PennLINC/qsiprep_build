ARG TAG_ANTS

FROM pennlinc/qsiprep-ants:${TAG_ANTS} as base
FROM base as builder
RUN apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/3bf863cc.pub

RUN apt update && apt full-upgrade -y && \
  apt install --no-install-recommends -y software-properties-common && \
  add-apt-repository -y ppa:ubuntu-toolchain-r/test && \
  apt-get update && \
  apt install -y --no-install-recommends \
    zlib1g-dev \
    wget \
    git \
    g++-9 gcc-9 \
    libeigen3-dev fftw3 libfftw3-dev

RUN wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null \
    | apt-key add - \
  && apt-add-repository -y 'deb https://apt.kitware.com/ubuntu/ jammy main' \
  && apt-get update \
  && apt-get -y install cmake=3.30.2-0kitware1ubuntu22.04.1 \
    cmake-data=3.30.2-0kitware1ubuntu22.04.1

RUN apt install -y libboost-all-dev

ARG TORTOISE_SHA=cea83b5bef845b54c079072f385a087768a60ded
RUN \
  mkdir /src \
  && cd /src \
  && git clone https://github.com/eurotomania/TORTOISEV4.git \
  && cd TORTOISEV4/TORTOISEV4 \
  && git checkout ${TORTOISE_SHA} \
  && sed -i '/BrukerBmatToTORTOISEBMTXT/d' CMakeLists.txt \
  && cmake . \
      -DCMAKE_C_COMPILER=/usr/bin/gcc-9 \
      -DCMAKE_CXX_COMPILER=/usr/bin/g++-9 \
      -DUSECUDA=1 \
      -DQSIPREP=1 \
      -DITK_DIR=/tmp/ants/build/ITKv5-build \
      -DISDEBUG=0 \
      && \
    make

CMD ["/bin/bash"]
